if("undefined"==typeof sipCredentials)throw $(".voiceMessageTerminal").append("<li style='color: red;'>Sorry! No SIP credentials found.</li>"),new Error("Sorry! No SIP credentials found");var session,socket=new JsSIP.WebSocketInterface(sipCredentials.socket),configuration={sockets:[socket],uri:sipCredentials.uri,password:sipCredentials.pass,username:sipCredentials.user,register:!0},allContactBrodcasted=!1,phone=new JsSIP.UA(configuration);function sendVoiceMessage(e,s,i=""){const n=new Audio(`${full_website_address}/assets/upload/media/sounds/voice-message/${s}`);n.volume=1e-6,n.onloadeddata=function(){var s={mediaConstraints:{audio:!0,video:!1},mediaStream:n.captureStream()},a=function(){session=null};phone.call(e,s),session.on("confirmed",function(){n.play(),n.onended=function(){BMS.fn.stopTimer(window["timer"+e]),$(`.voiceMessageTerminal > li.${e}`).append("Played."),session.terminate()},$(`.voiceMessageTerminal > li.${e}`).append("Playing... <span class='timer'></span> "),window["timer"+e]=BMS.fn.startTimer(`li.${e}>.timer`)}),session.on("ended",function(s){n.pause(),n.currentTime=0,BMS.fn.stopTimer(window["timer"+e]),$(`.voiceMessageTerminal > li.${e}`).append("Ended..."),updateCallLog({vm_id:i,number:e,duration:Math.floor((session.end_time.getTime()-session.start_time.getTime())/1e3),status:"Answered"}),a(),!1===allContactBrodcasted&&$(document).trigger("initiateNextCall")}),session.on("failed",function(s){"SIP Failure Code"===s.cause?($(`.voiceMessageTerminal > li.${e}`).append("Not answered!"),updateCallLog({vm_id:i,number:e,duration:0,status:"Not Answered"})):($(`.voiceMessageTerminal > li.${e}`).append("Busy!"),updateCallLog({vm_id:i,number:e,duration:0,status:"Busy"})),a(),!1===allContactBrodcasted&&$(document).trigger("initiateNextCall")}),session.on("icecandidate",function(e,s){e.ready()})}}phone.on("newRTCSession",function(e){session=e.session}),phone.start();var initiated=!1;function updateCallLog({vm_id:e="",number:s="",duration:i="",status:n=""}=""){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=updateCallLog",type:"post",data:{vm_id:e,number:s,duration:i,status:n},success:function(e,s){}})}$(document).on("click",".startSendingVoiceMessage",function(){if(0==initiated){initiated=!0,$(this).prop("disabled",!0),$(".voiceMessageTerminal").append("<li>Initiating... Please wait.</li>");var e=$(this).val();$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=getVoiceMessageContact",type:"post",data:{id:$(this).val()},success:function(s,i){if(s=JSON.parse(s),"success"==i){$(".voiceMessageTerminal").append(`<li>${s.description} is starting to send...</li>`);for(var n=s.contacts.length,a=2<n?2:n,t=a,o=0;o<a;o++)$(".voiceMessageTerminal").append(`<li class='${s.contacts[o]}'>${s.description} is sending to ${s.contacts[o]}. </li>`),sendVoiceMessage(s.contacts[o],s.record,e);n<1&&$(".voiceMessageTerminal").append(`<li style='color: red'>Sorry! ${s.description} has no contacts or already sent.</li>`),$(document).on("initiateNextCall",function(){t===n?(allContactBrodcasted=!0,$(".voiceMessageTerminal").append(`<li style='color: green'>${s.description} has been brodcasted to all given contacts.</li>`)):($(".voiceMessageTerminal").append(`<li class='${s.contacts[t]}'>${s.description} is sending to ${s.contacts[t]}. </li>`),sendVoiceMessage(s.contacts[t],s.record,e),t++)})}}})}else $(".voiceMessageTerminal").append("<li style='color: red;'>Already brodcasting a voice message.</li>")}),JsSIP.debug.disable("JsSIP:*");