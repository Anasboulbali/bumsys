if("undefined"==typeof sipCredentials)throw new Error("Sorry! No SIP credentials found");navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,void 0!==navigator.getUserMedia?navigator.getUserMedia({audio:!0},(function(){$("#callButton").prop("disabled",!1)}),(function(){$("#status").html("<div style='font-size: 14px;' class='alert alert-danger'>No microphone found! Please connect your mic and reload!</div>").show(),$("#callButton").prop("disabled",!0)})):($("#status").html("<div style='font-size: 14px;' class='alert alert-danger'>Sorry! No media found. This module will not work.</div>").show(),$("#callButton").prop("disabled",!0));var remoteAudio=new window.Audio;remoteAudio.autoplay=!0,remoteAudio.crossOrigin="anonymous";var session,socket=new JsSIP.WebSocketInterface(sipCredentials.socket),configuration={sockets:[socket],uri:sipCredentials.uri,password:sipCredentials.pass,username:sipCredentials.user,register:!0},callOptions={mediaConstraints:{audio:!0,video:!1}},caller="",callerDisplay="",hideNumbers=["*78","*79","*76"],phone=new JsSIP.UA(configuration);function addCallLog({caller:e="",direction:t="",duration:a="",status:l=""}=""){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=addCallLog",type:"post",data:{caller:e,direction:t,duration:a,status:l,feedback:$("#callFeedback").val(),reviewer:$("#feedbackReviewer").val()},success:function(e,t){}})}function dial(e){phone.isConnected()?($(".numberSearch").prop("disabled",!0),$(".number-dialer-div .input-group-addon").addClass("disable-number-dialer-div"),session=phone.call(e.trim(),callOptions),$("#status").html(`Call is being send to ${e}...`).show(),$("#callButton, #hangButton").toggle(),showCallerDetails(caller),$("#callFeedback, #feedbackReviewer").val(""),$(document).off("change","#callFeedback, #feedbackReviewer"),$(".suggestion-numbers").html("").hide()):$("#status").html("<div style=\"font-size: 16px;\" class='alert alert-danger'>Sorry! The signaling server is disconnected.</div>").show()}function showCallerDetails(e){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=getCallerAllDetails",type:"post",data:{caller:e},success:function(t,a){if("success"==a){var l=JSON.parse(t);if(session&&"incoming"===session.direction&&(void 0!==l.details.type?BMS.fn.desktopNotify(`${l.details.name} (${e}) is calling...`,full_website_address+"/assets/images/call.png",`${l.details.type}, ${l.details.designation}`):BMS.fn.desktopNotify(`${e} is calling...`,full_website_address+"/assets/images/call.png","Click Here to open the dashboard")),Object.keys(l.details).length>0){$(".callerInfo > tbody > tr:nth-child(1) > td:nth-child(2)").html(l.details.name),$(".callerInfo > tbody > tr:nth-child(2) > td:nth-child(2)").html(l.details.type),$(".callerInfo > tbody > tr:nth-child(3) > td:nth-child(2)").html(l.details.designation),$(".callerInfo > tbody > tr:nth-child(4) > td:nth-child(2)").html(l.details.address),$(".dataToCopy").html(`<table><tr><td>${l.details.name}, ${l.details.type} \n ${l.details.designation}</td> <td>${e}</td> <td>${l.details.address}</td></tr></table>`);var n=`<a class="btn btn-primary" data-toggle="modal" href="<?php echo full_website_address(); ?>${l.details.editUri}${l.details.id}" data-target="#modalDefault">Edit ${l.details.type}</a>`;1==l.details.has_sc&&(n+=`<a style="margin-left: 15px;" class="btn btn-primary" data-toggle="modal" href="<?php echo full_website_address(); ?>/xhr/?module=marketing&page=viewSpecimenProduct&id=${l.details.id}" data-target="#modalDefault">View Specimen Copies</a>`),n+='<button style="margin-left: 15px;" type="button" class="btn btn-info" \n onclick="BMS.fn.copy(\'.dataToCopy\')" \n >\n Copy\n </button>',$(".callerInfo > tbody > tr:nth-child(5) > td:nth-child(2)").html(n)}else $(".callerInfo > tbody > tr:nth-child(1) > td:nth-child(2)").html("No data found in database"),$(".callerInfo > tbody > tr:nth-child(2) > td:nth-child(2)").html(""),$(".callerInfo > tbody > tr:nth-child(3) > td:nth-child(2)").html(""),$(".callerInfo > tbody > tr:nth-child(4) > td:nth-child(2)").html(""),$(".callerInfo > tbody > tr:nth-child(5) > td:nth-child(2)").html("");if($(".callerOrderInfo > tbody").html('<tr><td colspan="4">Sorry! No order found.</td></tr>'),l.orderHistory.length>0){var s="";l.orderHistory.forEach((e=>{s+=`<tr>\n <td>${e.date}</td>\n <td> <a data-toggle='modal' data-target='#modalDefault' href='<?php echo full_website_address(); ?>/xhr/?module=reports&page=showInvoiceProducts&id=${e.id}'> ${e.reference} </a> </td>\n <td>${e.total}</td>\n <td>${e.payment_status}</td>\n <td class="text-center">\n <iledit data-val="${e.status}">${e.status}</iledit>\n <pkey>${e.id}</pkey>\n </td>\n <td>\n <a class="btn btn-xs btn-flat btn-primary" data-toggle='modal' data-target='#modalDefault' href='<?php echo full_website_address(); ?>/xhr/?module=my-shop&page=editSaleNote&id=${e.id}'> Edit Note </a>\n <a target="_blank" class="btn btn-xs btn-flat btn-primary" href='<?php echo full_website_address(); ?>/sales/pos/?edit=${e.id}'> Edit Sale</a>\n </td>\n </tr>`})),$(".callerOrderInfo > tbody").hide().html(s).show("fast")}if($(".call-history").html("<p>No call</p>"),$(".call-count").html(`( ${l.totalCallCount} )`),l.callHistory.length>0){var o="";l.callHistory.forEach((e=>{o+=`<div class="call-item">\n <p style="font-weight: bold;" >Cause: <span style='color: green;'>${e.call_reason}</span>; \n <span style="margin-left: 10px;"><i class="fa fa-clock-o"></i> ${new Date(1e3*e.duration).toISOString().substr(14,5)}</span> </p>\n <p>\n <span>Direction: <b>${e.call_direction}</b> </span>\n <span style="margin-left: 10px;">Status: <b>${e.call_status}</b> </span>\n </p>\n <p>${e.call_datetime}; By- <b>${e.agent_name}</b></p>\n <p class="bg-info" style="padding: 2px 5px;">${e.feedback}</p>\n\n </div>`})),$(".call-history").hide().html(o).show("fast"),Number(l.totalCallCount)>5&&$(".call-history").append('<div class="text-center"><button type="button" class="btn btn-info loadCallHistory">Load More</button></div>')}if($(".case-history").html("<p>No Cases</p>"),l.caseHistory.length>0){var i="";l.caseHistory.forEach((e=>{i+=`<div class="call-item">\n <div class="call-item">\n <p style="font-weight: bold;"> <a target="_blank" href='<?php echo full_website_address(); ?>/customer-support/case-list/?case_id=${e.case_id}'>${e.case_title}</a> </p>\n <p><b>Status:</b> ${e.case_status}</p>\n <p>${e.case_datetime}; By- <b>${e.posted_by_name}</b></p>\n </div>\n </div>`})),$(".case-history").hide().html(i).show("fast")}if($(".case-history").html("<p>No Cases</p>"),l.smsHistory.length>0){var r="";l.smsHistory.forEach((e=>{r+=`<div class="message-item">\n <p>${e.sms_text}</p>\n <p>${e.send_time}; By- <b>${e.agent_name}</b></p>\n </div>`})),$(".message-history").hide().html(r).show("fast")}}}}),$(".call-center-tabs > li").show(),$('.nav-tabs a[href="#tab_leads"]').tab("show")}phone.start(),phone.on("newRTCSession",(function(e){var t=e.session;if(session)return addCallLog({caller:t.remote_identity.uri.user,direction:t.direction,duration:0,status:"Missed"}),t.terminate(),!1;var a=function(){session=null,$("#muteCall, #holdCall").show(),$("#unholdCall, #unmuteCall").hide()};caller=(session=t).remote_identity.uri.user,callerDisplay=session.remote_identity.display_name,$("#csSmsSendTo").val(caller),$("#feedbackCaller").val(caller),session.on("ended",(function(){jQuery.inArray(caller,hideNumbers)<0&&(addCallLog({caller:caller,direction:session.direction,duration:Math.floor((session.end_time.getTime()-session.start_time.getTime())/1e3),status:"Answered"}),BMS.fn.pause(),BMS.fn.stopTimer(window.timer),$("#status").html(`${caller} is disconnected`).show(),$("#timer").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(500).fadeIn(500),$("#hangButton").prop("disabled",!0),$('.nav-tabs a[href="#tab_feedback"]').tab("show"),phone.stop()),a()})),session.on("failed",(function(e){$(".call-dialer").show(),$("#callReceiver").hide(),BMS.fn.pause(),$("#callButton").show(),$("#hangButton").hide(),$(".numberSearch, #hangButton").prop("disabled",!1),$(".number-dialer-div .input-group-addon").removeClass("disable-number-dialer-div"),"incoming"===session.direction?"local"===e.originator?$("#status").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(250).fadeIn(250,(function(){$("#status").html("Call rejected!").show(),addCallLog({caller:caller,direction:"incoming",duration:0,status:"Rejected"})})):($("#status").html(`Missed call from ${callerDisplay}!`).show(),addCallLog({caller:caller,direction:"incoming",duration:0,status:"Missed"})):"local"===e.originator?$("#status").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(250).fadeIn(250,(function(){$("#status").html("Dial a number!").show(),addCallLog({caller:caller,direction:"outgoing",duration:0,status:"Unreachable"})})):$("#status").fadeOut(100).fadeIn(100).fadeOut(150).fadeIn(150).fadeOut(200).fadeIn(200).fadeOut(250).fadeIn(250,(function(){"SIP Failure Code"===e.cause?($("#status").html("The number is not answered!").show(),addCallLog({caller:caller,direction:"outgoing",duration:0,status:"Not Answered"})):($("#status").html("The number is busy!").show(),addCallLog({caller:caller,direction:"outgoing",duration:0,status:"Busy"})),$('.nav-tabs a[href="#tab_feedback"]').tab("show")})),a()})),session.on("hold",(function(e){"remote"===e.originator?$("#status").html(`${caller} is hold you.`).show():$("#status").html(`${caller} is on hold.`).show()})),session.on("muted",(function(e){$("#status").html("Call is muted.").show()})),session.on("unmuted",(function(e){$("#status").html(`${caller} is connected.`).show()})),session.on("unhold",(function(){$("#status").html(`${caller} is connected.`).show()})),session.on("accepted",(function(){jQuery.inArray(caller,hideNumbers)<0&&($("#timer").show(),window.timer=BMS.fn.startTimer(),$("#status").html(`${caller} is connected.`).show())})),session.on("confirmed",(function(){var e=session.connection.getLocalStreams()[0],t=session.connection.createDTMFSender(e.getAudioTracks()[0]);session.sendDTMF=function(e){t.insertDTMF(e)}})),session.on("peerconnection",(e=>{const t=e.peerconnection;t.onaddstream=function(e){remoteAudio.srcObject=e.stream,remoteAudio.play()};var a=new MediaStream;t.getReceivers().forEach((function(e){a.addTrack(e.track)}))})),"incoming"===session.direction?(BMS.fn.play("incoming_call",!0),$("#status").html(`${callerDisplay} is calling...`).show(),$("#callReceiver").show(),$("#timer").hide(),$(".call-dialer").hide(),showCallerDetails(caller)):session.connection.addEventListener("addstream",(function(e){BMS.fn.pause(),remoteAudio.srcObject=e.stream}))})),$(document).on("click","#callButton",(function(){dial($(".numberSearch").val())})),$(document).on("click","#hangButton",(function(){session.terminate()})),$(window).on("beforeunload",(function(){session.terminate()})),$(document).on("click","#muteCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.mute(),$("#muteCall, #unmuteCall").toggle()})),$(document).on("click","#unmuteCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.unmute(),$("#muteCall, #unmuteCall").toggle()})),$(document).on("click","#holdCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.hold(),$("#holdCall, #unholdCall").toggle()})),$(document).on("click","#unholdCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call.");session.unhold(),$("#holdCall, #unholdCall").toggle()})),$(document).on("click","#transferCall",(function(){if(void 0===session)return BMS.fn.alertError("Sorry! There is no active call to transfer.");var e={};$.each(extentionNumbers,(function(t,a){e[a.extention]=a.name})),Swal.fire({title:"Please select the extension",input:"select",inputOptions:e,showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> Transfer Call',closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Destination number..."}).then((e=>{void 0!==e.value&&(session.refer(e.value),session.terminate())}))})),$(document).on("click","#enableDND",(function(){phone.call("*78",callOptions),localStorage.setItem("dnd","enable"),$("#enableDND, #disableDND, .dndAlert").toggle()})),$(document).on("click","#disableDND",(function(){phone.call("*79",callOptions),localStorage.setItem("dnd","disable"),$("#enableDND, #disableDND, .dndAlert").toggle()})),$(document).on("click","#callReceiveButton",(function(){session.answer(callOptions),$("#timer").show(),BMS.fn.pause()})),$(document).on("click","#IncomingCallHangButton",(function(){session.terminate(),BMS.fn.pause()})),$(document).on("click","#csSendSMS",(function(){$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=sendSMS",type:"post",data:{number:$("#csSmsSendTo").val(),text:$("#csSmsText").val()},success:function(e,t){"1"===e?(BMS.fn.alertSuccess("SMS successfully sent.",!1),$("#csSmsText").val("")):BMS.fn.alertError("SMS faild to send.")}})})),$(document).on("click",".addToSMSBox tr",(function(){var e="";$("td",this).slice(3,6).each((function(){e+=$(this).text()+"\n"})),$("#csSmsText").val((function(){return this.value+e}))})),$(document).on("click","#addNewCase",(function(){var e=full_website_address+"/xhr/?module=customer-support&page=newCase&num=";$("#modalDefaultMdm").modal("show").find(".modal-content").load(e+encodeURI(caller))})),$(document).on("click","#saveFeedback",(function(){var e=$("#callReason").find(":selected").val();""===e?BMS.fn.alertError("Please select call reason"):($.ajax({url:full_website_address+"/xhr/?module=customer-support&page=updateCallFeedback",type:"post",data:{caller:$("#feedbackCaller").val(),reason:e,feedback:$("#callFeedback").val(),specimenReceived:$("#specimenCopyReceived").val(),informative:$("#feedbackInformative").val(),saleOurProduct:$("#SaleOurProduct").val(),userOurProduct:$("#userOurProduct").val(),mrFeedback:$("#mrFeedback").val(),otherInformation:$("#otherInformation").val()},success:function(e,t){e.includes("success")?(BMS.fn.alertSuccess($(e).text(),!1),$("#feedbackCaller").val(""),$("#callFeedback").val("")):BMS.fn.alertError($(e).text()),$(".hidden_tab").hide(),$('.nav-tabs a[href="#tab_messages"]').tab("show"),$(".numberSearch, #hangButton").prop("disabled",!1),$(".number-dialer-div .input-group-addon").removeClass("disable-number-dialer-div"),$("#timer").html("00:00:00").hide(),$("#status").hide(),$("#hangButton").hide(),$("#callButton").show(),$(".call-dialer").show(),$("#callReceiver").hide()}}),phone.start())})),$(document).on("click",".quickFeedback > ul > li:not(:last-child)",(function(){$("#callFeedback").val($("#callFeedback").val()+$(this).text()+"\n")})),$(document).on("click",".quickFeedback > ul > li:last-child",(function(){Swal.fire({title:"Enter new feedback",input:"textarea",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Write feedback here"}).then((e=>{void 0!==e.value&&($.ajax({url:full_website_address+"/xhr/?module=customer-support&page=addNewNote",type:"post",data:{note:e.value,type:"feedback"}}),$(".quickFeedback > ul > li:last-child").before(`<li style='cursor:pointer;'>${e.value}</li>`))}))})),$(document).on("click",".userNote > ul > li:not(:last-child)",(function(){console.log("hi");var e=this;$("#csSmsText").val((function(){return this.value+$(e).text()+"\n"}))})),$(document).on("click",".userNote > ul > li:last-child",(function(){Swal.fire({title:"Enter note here",input:"textarea",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Write note here"}).then((e=>{void 0!==e.value&&($.ajax({url:full_website_address+"/xhr/?module=customer-support&page=addNewNote",type:"post",data:{note:e.value,type:"note"}}),$(".userNote > ul > li:last-child").before(`<li style='cursor:pointer;'>${e.value}</li>`))}))})),$(document).on("keypress",".numberSearch",(function(e){if("Enter"===e.key){var t=$(this).val();t.length<2?alert("Please enter a valid number to continue"):showCallerDetails(t)}})),$(document).on("click",".loadCallHistory",(function(){$(".loadCallHistory").html("<i class='fa fa-spin fa-refresh'></i> Loading..."),$.ajax({url:full_website_address+"/xhr/?module=customer-support&page=getCallHistoryData",type:"post",data:{caller:$(".numberSearch").val()},success:function(e,t){if("success"==t){var a=JSON.parse(e);if(a.length>0){var l="";a.forEach((e=>{l+=`<div class="call-item">\n <p style="font-weight: bold;" >Cause: <span style='color: green;'>${e.call_reason}</span>; \n <span style="margin-left: 10px;"><i class="fa fa-clock-o"></i> ${new Date(1e3*e.duration).toISOString().substr(14,5)}</span> </p>\n <p>\n <span>Direction: <b>${e.call_direction}</b> </span>\n <span style="margin-left: 10px;">Status: <b>${e.call_status}</b> </span>\n </p>\n <p>${e.call_datetime}; By- <b>${e.agent_name}</b></p>\n <p class="bg-info" style="padding: 2px 5px;">${e.feedback}</p>\n\n </div>`})),$(".call-history").append(l)}$(".loadCallHistory").remove()}}})})),JsSIP.debug.disable("JsSIP:*");